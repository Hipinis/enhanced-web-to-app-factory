name: Production Factory Engine
on:
  repository_dispatch:
    types: [start_build]

jobs:
  build_android:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå›¾çº¸åº“
        uses: actions/checkout@v4

      - name: é…ç½® Node.js å’Œ Java ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: è‡ªåŠ¨ç”Ÿæˆ Android éª¨æ¶å¹¶æ³¨å…¥æ ¸å¿ƒé…ç½®
        run: |
          npm init -y
          npm install @capacitor/core @capacitor/cli @capacitor/android
          mkdir www && echo "<html><body style='background:#111;color:#fff;text-align:center;padding-top:50px;'>Loading...</body></html>" > www/index.html
          
          echo '{
            "appId": "com.reality.app",
            "appName": "${{ github.event.client_payload.app_name }}",
            "webDir": "www",
            "server": {
              "url": "${{ github.event.client_payload.target_url }}",
              "cleartext": true,
              "allowNavigation": ["*"]
            }
          }' > capacitor.config.json

          npx cap add android

      - name: é”»é€ ä¸“å± App å›¾æ ‡
        run: |
          npm install -g @capacitor/assets
          mkdir -p assets
          
          if [ -n "${{ github.event.client_payload.icon_base64 }}" ]; then
            echo "${{ github.event.client_payload.icon_base64 }}" | base64 -d > assets/icon.png
          elif [ -n "${{ github.event.client_payload.icon_url }}" ]; then
            wget -q -O assets/icon.png "${{ github.event.client_payload.icon_url }}"
          else
            wget -q -O assets/icon.png "https://img.icons8.com/fluency/512/android-os.png"
          fi
          
          # è¡¥å…… Splash é¿å…å·¥å…·æŠ¥é”™
          cp assets/icon.png assets/splash.png
          
          npx @capacitor/assets generate --android

      - name: ç»ˆæåº•å±‚æ‰‹æœ¯ (æ³¨å…¥å¹¿å‘Šæ‹¦æˆªã€æ‚¬æµ®çƒã€è¿”å›é”®ä¿®å¤)
        env:
          PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          cat << 'EOF' > inject.py
          import os, json, urllib.request, base64

          payload = json.loads(os.environ['PAYLOAD'])

          # 1. ç»„è£… Native Alpha å¹¿å‘Šè§„åˆ™
          ad_domains = []
          ad_rules = payload.get('ad_rules', '')
          if ad_rules:
              for url in ad_rules.split(','):
                  if not url.strip(): continue
                  try:
                      req = urllib.request.Request(url.strip(), headers={'User-Agent': 'Mozilla/5.0'})
                      lines = urllib.request.urlopen(req, timeout=10).read().decode('utf-8').split('\n')
                      for line in lines:
                          if line.startswith('||') and '^' in line:
                              domain = line[2:line.find('^')]
                              ad_domains.append(f'"{domain}"')
                  except Exception as e:
                      print('è§„åˆ™ä¸‹è½½å¤±è´¥:', e)
          ad_domains = ad_domains[:2000] # é™åˆ¶æ•°é‡é˜²æ­¢å†…å­˜æº¢å‡º
          ad_array_str = ','.join(ad_domains)

          # 2. æ„å»ºæ‚¬æµ®çƒ JavaScript
          float_js = """
          (function(){
              if(document.getElementById('reality-fab')) return;
              var fab = document.createElement('div');
              fab.id = 'reality-fab';
              fab.innerHTML = 'âš™ï¸';
              fab.style.cssText = 'position:fixed;bottom:80px;right:20px;width:50px;height:50px;background:rgba(0,0,0,0.7);color:#fff;border-radius:25px;text-align:center;line-height:50px;font-size:24px;z-index:999999;box-shadow:0 4px 10px rgba(0,0,0,0.3);cursor:pointer;backdrop-filter:blur(5px);';
              document.body.appendChild(fab);
              
              var menu = document.createElement('div');
              menu.style.cssText = 'display:none;position:fixed;bottom:140px;right:20px;background:rgba(0,0,0,0.8);border-radius:10px;padding:10px;z-index:999998;color:white;flex-direction:column;gap:10px;backdrop-filter:blur(5px);';
              menu.innerHTML = '<div id="fab-dark" style="padding:8px 15px;background:#333;border-radius:5px;text-align:center;cursor:pointer;">ğŸŒ™ é»‘æš—æ¨¡å¼</div>' + 
                               '<div id="fab-exit" style="padding:8px 15px;background:#c0392b;border-radius:5px;text-align:center;cursor:pointer;">âŒ é€€å‡ºåº”ç”¨</div>';
              document.body.appendChild(menu);
              
              fab.onclick = function() { menu.style.display = menu.style.display === 'none' ? 'flex' : 'none'; };
              
              document.getElementById('fab-dark').onclick = function() {
                  document.documentElement.style.filter = document.documentElement.style.filter ? '' : 'invert(1) hue-rotate(180deg)';
                  menu.style.display = 'none';
              };
              document.getElementById('fab-exit').onclick = function() { AndroidNative.exitApp(); };
          })();
          """
          float_js_b64 = base64.b64encode(float_js.encode('utf-8')).decode('utf-8')

          # 3. ç”Ÿæˆå¹¶æ›¿æ¢å®‰å“åº•å±‚ MainActivity.java
          java_code = f"""
          package com.reality.app;
          import android.os.Bundle;
          import android.webkit.WebView;
          import android.webkit.WebResourceRequest;
          import android.webkit.WebResourceResponse;
          import com.getcapacitor.BridgeActivity;
          import com.getcapacitor.BridgeWebViewClient;
          import java.util.Arrays;
          import java.util.List;
          import android.util.Base64;
          import android.webkit.JavascriptInterface;

          public class MainActivity extends BridgeActivity {{
              private static final List<String> AD_DOMAINS = Arrays.asList({ad_array_str});

              @Override
              public void onCreate(Bundle savedInstanceState) {{
                  super.onCreate(savedInstanceState);
                  WebView webView = this.bridge.getWebView();
                  
                  // æä¾› JS é€€å‡ºåŸç”Ÿ App çš„æ¡¥æ¢
                  webView.addJavascriptInterface(new Object() {{
                      @JavascriptInterface
                      public void exitApp() {{ finish(); }}
                  }}, "AndroidNative");

                  webView.setWebViewClient(new BridgeWebViewClient(this.bridge) {{
                      @Override
                      public WebResourceResponse shouldInterceptRequest(WebView view, WebResourceRequest request) {{
                          String url = request.getUrl().toString();
                          for (String domain : AD_DOMAINS) {{
                              if (url.contains(domain)) {{
                                  return new WebResourceResponse("text/plain", "UTF-8", null);
                              }}
                          }}
                          return super.shouldInterceptRequest(view, request);
                      }}

                      @Override
                      public void onPageFinished(WebView view, String url) {{
                          super.onPageFinished(view, url);
                          String js = new String(Base64.decode("{float_js_b64}", Base64.DEFAULT));
                          view.evaluateJavascript(js, null);
                      }}
                  }});
              }}

              // æ ¸å¿ƒä¿®å¤ï¼šæ‹¦æˆªè¿”å›é”®å®ç°ç½‘é¡µåé€€
              @Override
              public void onBackPressed() {{
                  WebView webView = this.bridge.getWebView();
                  if (webView != null && webView.canGoBack()) {{
                      webView.goBack();
                  }} else {{
                      super.onBackPressed();
                  }}
              }}
          }}
          """
          with open('android/app/src/main/java/com/reality/app/MainActivity.java', 'w') as f:
              f.write(java_code)
          EOF
          python3 inject.py

      - name: é”»é€ çœŸæ­£çš„ APK
        run: |
          cd android
          cat <<EOT >> app/build.gradle
          configurations.all {
              resolutionStrategy.eachDependency { DependencyResolveDetails details ->
                  def requested = details.requested
                  if (requested.group == 'org.jetbrains.kotlin' && requested.name == 'kotlin-stdlib-jdk8') {
                      details.useVersion '1.8.22'
                  }
              }
          }
          EOT
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: äº¤ä»˜æˆå“
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.client_payload.app_name }}_Finished
          path: android/app/build/outputs/apk/debug/app-debug.apk
