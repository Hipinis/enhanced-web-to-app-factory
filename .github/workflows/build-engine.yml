name: Production Factory Engine
on:
  repository_dispatch:
    types: [start_build]

jobs:
  build_android:
    runs-on: ubuntu-latest
    steps:
      - name: æ£€å‡ºå›¾çº¸åº“
        uses: actions/checkout@v4

      - name: é…ç½® Node.js å’Œ Java ç¯å¢ƒ
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: è‡ªåŠ¨ç”Ÿæˆ Android éª¨æ¶å¹¶æ³¨å…¥æ ¸å¿ƒé…ç½®
        run: |
          npm init -y
          # æ ¸å¿ƒä¿®å¤ï¼šå¼•å…¥ status-bar æ’ä»¶è§£å†³é¡¶éƒ¨çŠ¶æ€æ é‡å é—®é¢˜
          npm install @capacitor/core @capacitor/cli @capacitor/android @capacitor/status-bar
          mkdir www && echo "<html><body style='background:#111;color:#fff;text-align:center;padding-top:50px;'>Loading...</body></html>" > www/index.html
          
          echo '{
            "appId": "com.reality.app",
            "appName": "${{ github.event.client_payload.app_name }}",
            "webDir": "www",
            "plugins": {
              "StatusBar": {
                "overlaysWebView": false,
                "style": "DARK"
              }
            },
            "server": {
              "url": "${{ github.event.client_payload.target_url }}",
              "cleartext": true,
              "allowNavigation": ["*"]
            }
          }' > capacitor.config.json

          npx cap add android

      - name: é”»é€ ä¸“å± App å›¾æ ‡ (çªç ´é˜²ç›—é“¾é‡ç»˜)
        run: |
          npm install -g @capacitor/assets
          sudo apt-get update
          sudo apt-get install -y imagemagick
          mkdir -p assets
          
          # æ ¸å¿ƒä¿®å¤ï¼šåŠ å…¥ -A "Mozilla/5.0" ä¼ªè£…æˆæµè§ˆå™¨ï¼Œçªç ´ç»å¤§å¤šæ•°å›¾åºŠçš„é˜²ç›—é“¾æ‹¦æˆª
          if [ -n "${{ github.event.client_payload.icon_base64 }}" ]; then
            echo "${{ github.event.client_payload.icon_base64 }}" | base64 -d > assets/icon_raw
          elif [ -n "${{ github.event.client_payload.icon_url }}" ]; then
            curl -L -A "Mozilla/5.0 (Windows NT 10.0; Win64; x64)" -q "${{ github.event.client_payload.icon_url }}" -o assets/icon_raw
          else
            curl -L -q "https://img.icons8.com/fluency/512/android-os.png" -o assets/icon_raw
          fi
          
          convert assets/icon_raw -resize 512x512 assets/icon.png
          cp assets/icon.png assets/splash.png
          npx @capacitor/assets generate --android

      - name: ç»ˆæåº•å±‚æ‰‹æœ¯ (åŠ¨æ€æ³¨å…¥å…¨å¼•æ“)
        env:
          PAYLOAD: ${{ toJSON(github.event.client_payload) }}
        run: |
          cat << 'EOF' > inject.py
          import os, json, urllib.request, base64

          payload = json.loads(os.environ['PAYLOAD'])

          # --- 1. ç½‘ç»œå±‚ Adblock è§„åˆ™å¼•æ“ ---
          ad_domains = set()
          ad_rules = payload.get('ad_rules', '')
          if ad_rules:
              for url in ad_rules.split(','):
                  if not url.strip(): continue
                  try:
                      req = urllib.request.Request(url.strip(), headers={'User-Agent': 'Mozilla/5.0'})
                      lines = urllib.request.urlopen(req, timeout=10).read().decode('utf-8').splitlines()
                      for line in lines:
                          line = line.strip()
                          if not line or line.startswith('#') or line.startswith('!') or line.startswith('@@') or line.startswith('['): continue
                          if '##' in line or '#@#' in line or '#?#' in line: continue
                          domain = ""
                          if line.startswith('0.0.0.0 ') or line.startswith('127.0.0.1 '):
                              parts = line.split()
                              if len(parts) >= 2: domain = parts[1]
                          elif line.startswith('||') and '^' in line:
                              domain = line[2:line.find('^')]
                          elif line.startswith('||'):
                              domain = line[2:]
                          elif '.' in line and ' ' not in line and '/' not in line and '=' not in line:
                              domain = line
                          if domain:
                              domain = domain.replace('\\', '\\\\').replace('"', '\\"')
                              ad_domains.add(f'"{domain}"')
                  except Exception as e:
                      pass
          ad_array_str = ','.join(list(ad_domains)[:4000])

          # --- 2. æ‚¬æµ®çƒã€æ— ç¼ç¿»è¯‘ä¸ DOM ç»ˆç»“è€… (JS) ---
          float_js = """
          (function(){
              if(document.getElementById('reality-fab')) return;

              /* æ ¸å¿ƒä¿®å¤ï¼šDOM å¹¿å‘Šç»ˆç»“è€… (ä¸“é—¨å¯¹ä»˜ Perchance ç­‰é¡½å›ºç‰›çš®ç™£) */
              setInterval(function(){
                  var ads = document.querySelectorAll('iframe, ins, [class*="ad-"], [class*="adsby"], [id*="ad-"], [id*="google_ads"], .ad-container');
                  for(var i=0; i<ads.length; i++) {
                      if(ads[i].style.display !== 'none') {
                          ads[i].style.display = 'none';
                          ads[i].style.width = '0';
                          ads[i].style.height = '0';
                      }
                  }
              }, 1000);

              /* æ¯›ç»ç’ƒé€€å‡ºå¯¹è¯æ¡† */
              var dialogOverlay = document.createElement('div');
              dialogOverlay.style.cssText = 'display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.5);backdrop-filter:blur(15px);-webkit-backdrop-filter:blur(15px);z-index:9999999;align-items:center;justify-content:center;opacity:0;transition:opacity 0.3s ease;';
              dialogOverlay.innerHTML = '<div style="background:rgba(255,255,255,0.15);border:1px solid rgba(255,255,255,0.3);padding:30px;border-radius:20px;text-align:center;box-shadow:0 10px 30px rgba(0,0,0,0.5);color:white;font-family:sans-serif;width:80%;max-width:300px;"><h2 style="margin:0 0 15px 0;font-size:20px;">é€€å‡ºåº”ç”¨</h2><p style="margin:0 0 25px 0;font-size:14px;opacity:0.8;">æ‚¨ç¡®å®šè¦é€€å‡ºå—ï¼Ÿ</p><div style="display:flex;gap:15px;"><button id="btn-cancel-exit" style="flex:1;padding:12px;border:none;border-radius:10px;background:rgba(255,255,255,0.1);color:white;font-size:15px;cursor:pointer;">å–æ¶ˆ</button><button id="btn-confirm-exit" style="flex:1;padding:12px;border:none;border-radius:10px;background:#c0392b;color:white;font-size:15px;cursor:pointer;">é€€å‡º</button></div></div>';
              document.body.appendChild(dialogOverlay);

              window.RealityApp = {
                  showExitDialog: function() { dialogOverlay.style.display = 'flex'; setTimeout(function(){ dialogOverlay.style.opacity = '1'; }, 10); },
                  hideExitDialog: function() { dialogOverlay.style.opacity = '0'; setTimeout(function(){ dialogOverlay.style.display = 'none'; }, 300); }
              };
              document.getElementById('btn-cancel-exit').onclick = window.RealityApp.hideExitDialog;
              document.getElementById('btn-confirm-exit').onclick = function() { AndroidNative.exitApp(); };

              /* æ‚¬æµ®çƒæœ¬ä½“ */
              var fab = document.createElement('div');
              fab.id = 'reality-fab';
              var fabIconUrl = '__FLOAT_ICON_URL__';
              var fabBase64 = '__FLOAT_ICON_BASE64__';
              if(fabBase64) { fab.innerHTML = '<img src="data:image/png;base64,' + fabBase64 + '" style="width:100%;height:100%;border-radius:50%;object-fit:cover;">'; }
              else if(fabIconUrl) { fab.innerHTML = '<img src="' + fabIconUrl + '" style="width:100%;height:100%;border-radius:50%;object-fit:cover;" onerror="this.outerHTML=\\'âš™ï¸\\'">'; }
              else { fab.innerHTML = 'âš™ï¸'; }
              
              fab.style.cssText = 'position:fixed;bottom:50px;right:20px;width:50px;height:50px;background:rgba(255,255,255,0.2);color:#fff;border-radius:25px;text-align:center;line-height:50px;font-size:24px;z-index:999998;box-shadow:0 4px 15px rgba(0,0,0,0.3);cursor:pointer;backdrop-filter:blur(10px);-webkit-backdrop-filter:blur(10px);border:1px solid rgba(255,255,255,0.1);display:flex;align-items:center;justify-content:center;overflow:hidden;';
              document.body.appendChild(fab);

              /* æ‚¬æµ®èœå• */
              var menu = document.createElement('div');
              menu.style.cssText = 'display:none;position:fixed;bottom:110px;right:20px;background:rgba(0,0,0,0.8);border-radius:15px;padding:10px;z-index:999997;color:white;flex-direction:column;gap:10px;backdrop-filter:blur(15px);transform:scale(0.9);opacity:0;transition:all 0.2s;';
              
              var mHTML = '';
              mHTML += '<div id="fab-home" style="padding:10px 15px;background:rgba(255,255,255,0.1);border-radius:8px;text-align:center;cursor:pointer;font-size:14px;white-space:nowrap;">ğŸ  è¿”å›é¦–é¡µ</div>';
              if('__FLOAT_TRANS__' === 'True') mHTML += '<div id="fab-trans" style="padding:10px 15px;background:rgba(255,255,255,0.1);border-radius:8px;text-align:center;cursor:pointer;font-size:14px;white-space:nowrap;">ğŸŒ åŸåœ°ç¿»è¯‘</div>';
              if('__FLOAT_DARK__' === 'True') mHTML += '<div id="fab-dark" style="padding:10px 15px;background:rgba(255,255,255,0.1);border-radius:8px;text-align:center;cursor:pointer;font-size:14px;white-space:nowrap;">ğŸŒ™ é»‘æš—æ¨¡å¼</div>';
              
              var cMenus = __CUSTOM_MENUS__;
              cMenus.forEach(function(item, idx) { mHTML += '<div id="fab-custom-'+idx+'" data-url="'+item.url+'" style="padding:10px 15px;background:rgba(255,255,255,0.1);border-radius:8px;text-align:center;cursor:pointer;font-size:14px;white-space:nowrap;">ğŸ”— '+item.label+'</div>'; });
              if('__FLOAT_EXIT__' === 'True') mHTML += '<div id="fab-exit" style="padding:10px 15px;background:rgba(231,76,60,0.3);border-radius:8px;text-align:center;cursor:pointer;font-size:14px;color:#ff7675;">âŒ é€€å‡ºåº”ç”¨</div>';
              menu.innerHTML = mHTML;
              document.body.appendChild(menu);

              fab.onclick = function() {
                  if(menu.style.display === 'none') { menu.style.display = 'flex'; setTimeout(function(){ menu.style.transform='scale(1)'; menu.style.opacity='1'; },10); } 
                  else { menu.style.transform='scale(0.9)'; menu.style.opacity='0'; setTimeout(function(){ menu.style.display='none'; },200); }
              };

              if(document.getElementById('fab-home')) document.getElementById('fab-home').onclick = function() { window.location.href = '__HOME_URL__' || '__TARGET_URL__'; };
              if(document.getElementById('fab-dark')) document.getElementById('fab-dark').onclick = function() { document.documentElement.style.filter = document.documentElement.style.filter ? '' : 'invert(1) hue-rotate(180deg)'; };
              
              /* æ ¸å¿ƒä¿®å¤ï¼šæ— ç¼å†…åµŒå¼ç¿»è¯‘å¼•æ“ */
              if(document.getElementById('fab-trans')) document.getElementById('fab-trans').onclick = function() {
                  menu.style.display='none';
                  if(document.getElementById('reality-translate-widget')) return;
                  var tWidget = document.createElement('div');
                  tWidget.id = 'reality-translate-widget';
                  tWidget.style.cssText = 'position:fixed;top:0;left:0;width:100%;background:white;z-index:9999999;box-shadow:0 2px 10px rgba(0,0,0,0.2);text-align:center;';
                  document.body.prepend(tWidget);
                  window.realityTranslateInit = function() {
                      new google.translate.TranslateElement({pageLanguage: 'auto', includedLanguages: 'zh-CN,en,ja', layout: google.translate.TranslateElement.InlineLayout.SIMPLE, autoDisplay: false}, 'reality-translate-widget');
                  };
                  var s = document.createElement('script');
                  s.src = 'https://translate.google.com/translate_a/element.js?cb=realityTranslateInit';
                  document.head.appendChild(s);
              };

              cMenus.forEach(function(item, idx) {
                  var el = document.getElementById('fab-custom-'+idx);
                  if(el) el.onclick = function() { window.location.href = this.getAttribute('data-url'); };
              });
              if(document.getElementById('fab-exit')) document.getElementById('fab-exit').onclick = function() { menu.style.display='none'; window.RealityApp.showExitDialog(); };
          })();
          """
          float_js = float_js.replace('__FLOAT_ICON_URL__', payload.get('float_icon_url', ''))
          float_js = float_js.replace('__FLOAT_ICON_BASE64__', payload.get('float_icon_base64', ''))
          float_js = float_js.replace('__FLOAT_TRANS__', str(payload.get('float_translate', True)))
          float_js = float_js.replace('__FLOAT_DARK__', str(payload.get('float_darkmode', True)))
          float_js = float_js.replace('__FLOAT_EXIT__', str(payload.get('float_exit', True)))
          float_js = float_js.replace('__HOME_URL__', payload.get('float_home_url', ''))
          float_js = float_js.replace('__TARGET_URL__', payload.get('target_url', ''))
          float_js = float_js.replace('__CUSTOM_MENUS__', json.dumps(payload.get('custom_menus', [])))
          float_js_b64 = base64.b64encode(float_js.encode('utf-8')).decode('utf-8')

          # --- 3. å®‰å“åº•å±‚æ ¸å¿ƒæ³¨å…¥ ---
          java_code = """
          package com.reality.app;
          import android.os.Bundle;
          import android.webkit.WebView;
          import android.webkit.WebResourceRequest;
          import android.webkit.WebResourceResponse;
          import com.getcapacitor.BridgeActivity;
          import com.getcapacitor.BridgeWebViewClient;
          import java.util.Arrays;
          import java.util.List;
          import android.util.Base64;
          import android.webkit.JavascriptInterface;

          public class MainActivity extends BridgeActivity {
              private static final List<String> AD_DOMAINS = Arrays.asList(__AD_DOMAINS__);
              private long lastBackPressTime = 0;

              @Override
              public void onCreate(Bundle savedInstanceState) {
                  super.onCreate(savedInstanceState);
                  if (__FULLSCREEN__) { getWindow().setFlags(1024, 1024); }
                  
                  WebView webView = this.bridge.getWebView();
                  webView.addJavascriptInterface(new Object() {
                      @JavascriptInterface
                      public void exitApp() { finish(); }
                  }, "AndroidNative");

                  webView.setWebViewClient(new BridgeWebViewClient(this.bridge) {
                      @Override
                      public WebResourceResponse shouldInterceptRequest(WebView view, WebResourceRequest request) {
                          String url = request.getUrl().toString();
                          for (String domain : AD_DOMAINS) {
                              if (url.contains(domain)) { return new WebResourceResponse("text/plain", "UTF-8", null); }
                          }
                          return super.shouldInterceptRequest(view, request);
                      }
                      @Override
                      public void onPageFinished(WebView view, String url) {
                          super.onPageFinished(view, url);
                          view.evaluateJavascript(new String(Base64.decode("__B64_JS__", Base64.DEFAULT)), null);
                      }
                  });
              }

              @Override
              public void onBackPressed() {
                  WebView webView = this.bridge.getWebView();
                  if (webView != null && webView.canGoBack()) {
                      webView.goBack();
                  } else {
                      long currentTime = System.currentTimeMillis();
                      if (currentTime - lastBackPressTime < 2000) {
                          webView.evaluateJavascript("if(window.RealityApp) { window.RealityApp.showExitDialog(); }", null);
                          lastBackPressTime = 0;
                      } else {
                          lastBackPressTime = currentTime;
                          android.widget.Toast.makeText(this, "å†æŒ‰ä¸€æ¬¡å”¤å‡ºé€€å‡ºèœå•", android.widget.Toast.LENGTH_SHORT).show();
                      }
                  }
              }
          }
          """
          java_code = java_code.replace('__AD_DOMAINS__', ad_array_str)
          java_code = java_code.replace('__FULLSCREEN__', str(payload.get('fullscreen', False)).lower())
          java_code = java_code.replace('__B64_JS__', float_js_b64)

          with open('android/app/src/main/java/com/reality/app/MainActivity.java', 'w') as f:
              f.write(java_code)
          EOF
          python3 inject.py

      - name: é”»é€ çœŸæ­£çš„ APK
        run: |
          cd android
          cat <<EOT >> app/build.gradle
          configurations.all {
              resolutionStrategy.eachDependency { DependencyResolveDetails details ->
                  def requested = details.requested
                  if (requested.group == 'org.jetbrains.kotlin' && requested.name == 'kotlin-stdlib-jdk8') {
                      details.useVersion '1.8.22'
                  }
              }
          }
          EOT
          chmod +x gradlew
          ./gradlew assembleDebug

      - name: äº¤ä»˜æˆå“
        uses: actions/upload-artifact@v4
        with:
          name: ${{ github.event.client_payload.app_name }}_Finished
          path: android/app/build/outputs/apk/debug/app-debug.apk
